---
title: 接入配置(DeviceConfig)
description: driver-box配置化设备接入的设计和工作原理
sidebar:
  order: 5
---

import { Tabs, TabItem } from '@astrojs/starlight/components';

# 配置化接入

config.json 是 driver-box 用于实现设备接入的描述文件。通过编写该配置文件,即可实现设备接入,无需编写大量代码。

## 配置文件结构

```json5 title="config.json"
{
  "deviceModels": [
    {
      "name": "sensor",
      "modelId": "sensor_001",
      "description": "温湿度传感器",
      "devicePoints": [],
      "devices": []
    }
  ],
  "connections": {},
  "protocolName": "modbus"
}
```

## 配置参数说明

<Tabs>
    <TabItem label="config.json">
        | 参数名 | 类型 | 必填 | 说明 |
        |:---|--------|:---|:---|
        | deviceModels | array | 必填 | 设备模型配置,定义协议类型及其接入设备列表 |
        | connections | object | 必填 | 连接配置,不同插件配置各不相同 |
        | protocolName | string | 必填 | 协议插件名称,有效范围: modbus、bacnet、mqtt、httpserver 等 |
    </TabItem>
    <TabItem label="deviceModels">
        | 参数名 | 类型 | 必填 | 说明 |
        |:---|--------|:---|:---|
        | name | string | 必填 | 设备模型名称 |
        | modelId | string | 必填 | 物模型 ID |
        | description | string | 可选 | 设备模型描述 |
        | devicePoints | array | 必填 | 设备点表配置 |
        | devices | array | 必填 | 设备列表 |
    </TabItem>
    <TabItem label="devicePoints">
        | 参数名 | 类型 | 必填 | 说明 |
        |:---|--------|:---|:---|
        | name | string | 必填 | 点位名称 |
        | description | string | 可选 | 点位描述 |
        | valueType | string | 必填 | 点位值类型,有效范围: int、float、string |
        | readWrite | string | 必填 | 点位读写类型,有效范围: R(只读)、W(只写)、RW(读写) |
        | reportMode | string | 必填 | 点位上报模式,有效范围: realTime(实时)、change(变化)、period(周期) |
        | scale | float | 可选 | 点位值系数换算。读操作: 读取值 × scale; 写操作: 设定值 ÷ scale |
        | decimals | float | 可选 | 保留小数位数,仅针对 valueType=float 有效 |
        | unit | string | 可选 | 点位单位,例如: ℃、m、s |
        | enums | array | 可选 | 枚举值列表 |
    </TabItem>
    <TabItem label="devices">
        | 参数名 | 类型 | 必填 | 说明 |
        |:---|--------|:---|:---|
        | id | string | 必填 | 设备序列号 |
        | description | string | 选填 | 设备描述 |
        | ttl | string | 选填 | 设备离线阈值,示例: 1m(1分钟)、1h(1小时)、1d(1天),默认: 24h |
        | connectionKey | string | 必填 | 设备连接标识 |
        | driverKey | string | 选填 | 设备驱动标识 |
        | properties | object | 选填 | 设备属性,用于配置保留属性 |

        **保留属性**
        保留属性是 driver-box 为设备提供的扩展信息配置能力。目前开放的保留属性:
        - _area: 设备所处的区域信息
        - _parent_sn: 父级设备 SN
        - _system_id: 设备所属的系统 ID
    </TabItem>
    <TabItem label="connections">
        不同协议插件的连接配置各不相同,详见各插件文档:
        - [Modbus 连接配置](/driver-box/plugins/modbus/#modbus连接配置)
        - MQTT 连接配置
        - HTTP Server 连接配置
        - TCP Server 连接配置
    </TabItem>
</Tabs>

## 配置示例

### Modbus 设备配置

```json5
{
  "protocolName": "modbus",
  "deviceModels": [
    {
      "name": "temp_sensor",
      "modelId": "MODBUS_TEMP_001",
      "description": "Modbus 温度传感器",
      "devicePoints": [
        {
          "name": "temperature",
          "description": "温度值",
          "valueType": "float",
          "readWrite": "R",
          "reportMode": "realTime",
          "unit": "℃",
          "scale": 0.1,
          "decimals": 1,
          "primaryTable": "HOLDING_REGISTER",
          "startAddress": "40001",
          "rawType": "uint16",
          "slaveId": 1
        }
      ],
      "devices": [
        {
          "id": "temp-001",
          "description": "会议室温度传感器",
          "connectionKey": "modbus-tcp-001",
          "ttl": "60s"
        }
      ]
    }
  ],
  "connections": {
    "modbus-tcp-001": {
      "host": "192.168.1.100",
      "port": 502,
      "timeout": 5000,
      "retryTimes": 3,
      "protocol": "tcp"
    }
  }
}
```

### MQTT 设备配置

```json5
{
  "protocolName": "mqtt",
  "deviceModels": [
    {
      "name": "mqtt_sensor",
      "modelId": "MQTT_SENSOR_001",
      "description": "MQTT 传感器",
      "devicePoints": [
        {
          "name": "status",
          "description": "设备状态",
          "valueType": "string",
          "readWrite": "R",
          "reportMode": "change",
          "topic": "device/{device.id}/status",
          "qos": 1
        }
      ],
      "devices": [
        {
          "id": "mqtt-001",
          "description": "MQTT 温度传感器",
          "connectionKey": "mqtt-broker-001"
        }
      ]
    }
  ],
  "connections": {
    "mqtt-broker-001": {
      "broker": "tcp://mqtt.example.com:1883",
      "clientId": "driver-box-client",
      "username": "user",
      "password": "pass",
      "qos": 1
    }
  }
}
```

## 配置验证

系统启动时会对配置进行以下验证:

- **设备 ID 验证**: 设备 ID 不能为空,且必须唯一
- **点位配置验证**: 点位名称、类型、读写模式、上报模式必须符合规范
- **模型验证**: 模型名称必须唯一,必须包含点位定义
- **连接验证**: 设备引用的连接必须在 connections 中定义

### 验证规则

| 验证项 | 规则 |
|--------|------|
| 点位名称 | 不能为空 |
| 点位类型 | 必须是 int、float 或 string |
| 读写模式 | 必须是 R、W 或 RW |
| 上报模式 | 必须是 realTime、change 或 period |
| 缩放比例 | 不为 0 或 1 时,点位类型必须是 float |

## 配置热更新

driver-box 支持配置热更新,无需重启系统:

### 自动持久化

- 配置变更后每 5 秒自动写入磁盘
- 避免频繁写入,提高性能

### 手动刷新

```go
// 刷新指定插件配置
driverbox.CoreCache().Flush("modbus")

// 刷新所有插件配置
driverbox.CoreCache().FlushAll()
```

### 配置更新 API

```go
// 更新设备属性
driverbox.CoreCache().UpdateDeviceProperty("device-001", "location", "room-101")

// 更新设备描述
driverbox.CoreCache().UpdateDeviceDesc("device-001", "新的设备描述")
```

## 配置文件位置

配置文件默认位于 `res/driver/{pluginName}/config.json`,可通过环境变量 `DRIVERBOX_RESOURCE_PATH` 自定义路径。

```
res/driver/
├── modbus/
│   └── config.json
├── mqtt/
│   └── config.json
└── ...
```

## 调试与排错

### 启用调试日志

```bash
export LOG_LEVEL=debug
./driver-box
```

### 验证配置文件

```bash
# 检查 JSON 语法
python -m json.tool res/driver/modbus/config.json
```

### 查看错误日志

```bash
tail -f logs/driver-box.log | grep ERROR
```

## 相关文档

- [CoreCache](/driver-box/concepts/corecache/) - 了解核心缓存系统如何加载配置
- [Library](/driver-box/concepts/library/) - 了解资源库中的模型和驱动配置
- [Plugin 机制](/driver-box/concepts/plugin-system/) - 了解插件如何使用配置
- [快速开始](/driver-box/guides/getting-started/) - 查看完整配置示例
